# 计算机网络协议整理

### OSI/RM模型---数据链路层协议---帧(frame)

#### 面向字符协议：利用已定义好的一种代码字符集的一个子集来执行通信控制功能---具体协议有 ISO 1745,BSC

##### 该协议面临的问题： 1.字符集不同
			2.数据字符和控制字符的区分
			3.控制字符占用了可传输信息的空间
			4.透明性差，需要复杂的转义技术（DLE）
	透明性：指链路控制与传输的代码结构完全无关

#### 面向位协议:以位置来定位各个字段，各字段内均由位的各种组合组成，并以帧为统一的传输单位---具体协议有 SDLC,ADCCP,HDLC,LAP,LAPB
		    	    |->ADCCP		    
	关系为   SDLC(最初) | ->HDLC ->LAP ->LAPB
	（这些协议基本内容相同）

### OSI/RM模型---网络层---数据包/分组(packet)

#### X.25协议：定义了用户主机（数据终端设备，DTE）和报文分组网通信设备(数据终接设备，DCE)。
	具体地说，它是3个对等协议的组合：
	- DTE和DCE物理实体之间对等层协议
	- DTE和DCE数据链路层之间的对等层协议
	- DTE和DCE网络层之间的对等层协议
它定义了这三个层在DTE和DCE之间交换信息的格式和意义。（即包含了三个协议层）
### OSI/RM模型---传输层---段(segment)

#### 该层协议共分为5类

	协议类	网络类型	  名称
	  0       A类		简单类
	  1 	  B类		基本错误恢复类
	  2 	  A类   	多路复用类
	  3	  B类		差错恢复与多路复用类
	  4	  C类   	差错检测和恢复类

其中，网络类型的区别为：A型---具由可接受的残留差错率和失效通知率
			B型---具由可接受的残留差错率
			C型---两者都不可接受

##### TCP，传输控制协议
	TCP是TCP/IP中传输层采用的一种协议
	它从上层实体接受任意长度的报文，并为上层用户提供面向连接的，可靠的全双工数据传输服务。
	它是一种面向连接的协议，需要在一对高层实体间提供建立连接和释放连接的功能，连接方法是利用套接字。
	它适用于可靠或不可靠的网络。
##### UDP，用户数据报协议
	UDP是一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。
	它不提供数据包分组、组装，不能对数据包进行排序。
	常用于支持那些需要在计算机之间传输数据的网络应用。
### OSI/RM模型---会话层---数据(data)
	

### 高层协议
	以下列举的应用、表示、会话层协议可供用（由于实际的网络协议将它们归了一类所致）
#### 具有会话层功能
	ADSP·ASP·H.245·ISO-SP·iSNS·NetBIOS·PAP·RPC·
	
	RTCP·SMPP·SCP·SSH·ZIP·SDP
#### 会话层功能
	

	会话层内的供能就是会话实体为了提供会话服务应执行的那些功能，这些功能必须由会话实体来完成。
	1.会话连接到传输连接的映射
	2.会话连接的流程控制
	3.加速数据传送
	4.会话连接的恢复
	5.会话连接释放
	6.会话连接管理
### OSI/RM模型---表示层---数据(data)
#### 具有表示层功能		
	HTTP/HTML · Telnet · ASN.1
### 表示层功能
	1.表示实体之间的连接建立、释放
	2.数据语法和图像语法的表示和转换
	3.传送语法的选择
	4.数据变换的特殊处理，如代码压缩 、密码转换等
### OSI/RM模型---应用层---数据(data)
#### 应用层协议
##### 文件传输协议---FTP
	它基于传输层为用户服务，负责进行文件的传输。它能操作任何类型的文件而不需要进一步的处理，但是有着极高的延迟	
##### 电子邮件协议---SMTP、POP3、IMAP4
###### SMTP协议，简单邮件传输协议。
	它是一组用于从源地址到目的地址传输邮件的规范，通过它来控制邮件的中转方式。
###### POP3协议，邮局协议的第三个版本
	它是因特网电子邮件的第一个离线协议标准。
###### IMAP4
	POP3的一种替代协议，添加了邮件检索与处理等新功能
##### 远程登录协议--- Telnet
	它是Internet远程登录服务的标准协议和主要方式。
	通过创建虚拟终端提供连接到远程终端的仿真，通过用户名和密码进行认证，为用户提供了在本地计算机上完成远程主机工作的能力。
##### 简单网络管理协议 --- SNMP、SNMP V2
	其被采纳为基于TCP\IP的各种互联网络的管理标准。
	它的核心思想就是，在每个网络节点上存放一个管理信息库（MIB），由节点上的代理负责维护，管理者通过应用层协议对这些信息库进行管理。
	它的最大特点就是 简单性 
	SNMP标准   由3部分组成：
	1.简单网络管理协议---SNMP
	2.管理信息结构---SMI
	3.管理信息库---MIB

注：SMI和MIB 是两个关于管理信息标准的协议，它们规定了被管理的网络对象的定义格式，MIB中包含哪些对象，以及怎样访问这些对象等。SMI规定了定义个标识变量的一组原则，它规定所有的MIB对象必须用ASN.1来定义。

## 局域网（LAN）中的协议
### 总线竞争型媒体访问控制方法
	总线型网常采用的是CSMA/CD协议，即带有冲突检测的载体侦听多路访问协议。它是一种采用随机访问技术的竞争型媒体访问控制方法，起源于ALOHA协议。
#### ALOHA协议
##### 纯ALOHA协议
	- 当传输点有数据需要传送的时候，它会立即向通讯频道传送。
	- 接收点在收到数据后，发送ACK帧（返回应答消息）回传输点。
	- 如果接收的数据有错误，接收点会向传输点发送NACK。
	- 当网络上的两个传输点同时向频道传输数据的时候，会发生冲突，这	种情况下，两个点各自等待一段随机长度的时间后，再次尝试传送。
	这种协议下，信道吞吐率很低
##### 分段ALOHA
	这是对纯ALOHA协议的一个改进。改进之处在于，它把频道在时间上分段，每个传输点只能在一个分段的开始处进行传送。每次传送的数据必须少于或者等于一个频道的一个时间分段。这样大大的减少了传输频道的冲突。
	
##### 载体侦听多路访问/冲突检测,即CSMA/CD协议
###### CSMA/CD的物理含义
	各站点在发送消息前，先侦听总线上是否有信息在传送。
若有，则不发，以免破坏传送；若没有，则发送。

	多路访问，是指当一个站点发送信息时，其他站点使用各自的接收器收听（类似于广播）。
	若目标地址是广播地址，则总线上所有站点都将接受信息并放在各自的缓冲区内以便处理；
	若目标地址是某指定站点，则该指定站点将接受信息；
	若目标地址是一个组地址，则该组地址都将接受信息；

	冲突检测，指当一个站点占用总线发送信息时，要一边发送一边检测总线，看是否有冲突产生。

	冲突的产生有两个原因：
	1.两个站点同时侦听到线路空闲，又同时发送信息导致冲突
	2.A站点刚发送信息还没有到达B站，B站此时检测到线路空闲，发送数据到总线上，导致冲突
###### CSMA/CD的特点
	该协议采用竞争的方法强占对媒体的访问权利。
	最小帧长为512位（64B）
	优点：
	1.结构简单
	2.网络维护方便
	3.增删节点容易
	4.网络在轻负载情况下效率较高
	缺点：
	1.重负载情况下，冲突概率增加，性能明显下降
	2.为了满足最小帧长的要求，额外添加的填充字段浪费了信道容量

## TCP/IP 网络通信协议
### TCP/IP的结构
	TCP/IP包括四层协议：
	1.应用层，应用程序间沟通的层
	2.传输层，提供节点间的数据传送，应用程序之间的通信服务，主要功能是数据格式化，数据确认和丢失重传
	3.网络层，负责提供基本的数据封包传送功能
	4.网络接口层（主机-网络层），接受IP数据报并进行传输，抽取IP数据报转交给下一层，是对实际的网络媒体的管理，定义如何使用实际网络来传送数据
### TCP/IP是一组协议的代名词，它还包括其他一些协议。

	TCP --- 传输层协议，负责流量控制和校验正确性
	IP  --- 网络层协议，负责传输数据

	在TCP/IP协议中，除了TCP和IP外，还有：
	- ARP，地址解析协议,此协议将网络地址映射到硬件地址，属于网络层协议
	- RARP，反向地址解析协议，此协议将硬件地址映射到网络地址，属于网络层协议
	- ICMP，网间报文控制协议，属于网络层协议
	- UDP，用户数据报协议，提供无连接服务，属于传输层协议
	- FTP，文件传输协议，允许用户以文件操作的方式与另一台主机相互通信，属于应用层协议
	- SMTP，简单邮件传输协议，属于应用层协议
	- Telnet，远程登陆协议，属于应用层协议
	- TFTP，简单文件传输协议，属于应用层协议
### 网络层协议
	网络层协议的主要功能是实现互联网络环境下的数据分组传输
	这些功能主要由4个功能实现：
	IP，ARP，RARP，ICMP
	
	IP --- 提供数据分组传输、路由选择等功能；
	ARP、RARP --- 提供逻辑地址与物理地址映射的功能
	ICMP --- 提供网络控制和差错处理功能
#### IPv4,即IP
	IP，提供无连接的数据报传输机制，IP数据报的格式与一般帧类似，分为报头和数据区两个部分
##### IP数据报格式
	格式如下图：
![IP数据报格式](https://raw.githubusercontent.com/CICSilver/leetCode/master/20170301092349308.png)

	- 版本：IP协议的版本，目前的IP协议版本号为4，下一代IP协议版本号为6。


	- 首部长度：IP报头的长度。固定部分的长度（20字节）和可变部分的长度之和。共占4位。最大为1111，即10进制的15，代表IP报头的最大长度可以为15个32bits（4字节），也就是最长可为15*4=60字节，除去固定部分的长度20字节，可变部分的长度最大为40字节。
	
- 
服务类型：Type Of Service。


	- 总长度：IP报文的总长度。报头的长度和数据部分的长度之和。
	

- 标识：唯一的标识主机发送的每一分数据报。通常每发送一个报文，它的值加一。当IP报文长度超过传输网络的MTU（最大传输单元）时必须分片，这个标识字段的值被复制到所有数据分片的标识字段中，使得这些分片在达到最终目的地时可以依照标识字段的内容重新组成原先的数据。


	- 标志：共3位。R、DF、MF三位。目前只有后两位有效，DF位：为1表示不分片，为0表示分片。MF：为1表示“更多的片”，为0表示这是最后一片。


	- 片位移：本分片在原先数据报文中相对首位的偏移位。（需要再乘以8）
	- 

生存时间：IP报文所允许通过的路由器的最大数量。每经过一个路由器，TTL减1，当为0时，路由器将该数据报丢弃。TTL 字段是由发送端初始设置一个 8 bit字段.推荐的初始值由分配数字 RFC 指定，当前值为 64。发送 ICMP 回显应答时经常把 TTL 设为最大值 255。
	- 

协议：指出IP报文携带的数据使用的是那种协议，以便目的主机的IP层能知道要将数据报上交到哪个进程（不同的协议有专门不同的进程处理）。和端口号类似，此处采用协议号，TCP的协议号为6，UDP的协议号为17。ICMP的协议号为1，IGMP的协议号为2.


	- 首部校验和：计算IP头部的校验和，检查IP报头的完整性。
	

- 源IP地址：标识IP数据报的源端设备。
	- 

目的IP地址：标识IP数据报的目的地址。
	- 可选字段：用以指定额外服务
##### 数据报的分段与重装
	1.分段，为了适应不同物理网络的信息传输，IP将对上层协议提交的协议根据物理网络允许的最大帧长进行检查，必要时会分段发送。
	分段时每一段都要加上IP报头，形成IP数据报（与分段有关的报头字段有，标识，报文长度，分段偏移，标志）
	2.重装，被分段的数据报在到达目标主机前可能经过不同路由器，导致到达顺序与发送时不同，因此IP必须根据报头中的相关字段重组数据报再提交给上层协议
##### 数据报的发送和接受
	1.发送。
		* 若上层协议已指定发送路由，则按指定路由发送数据报；
		+ 若上层协议未指定发送路由，则以报头中指定的IP地址为关键字来搜索路由表中的路由。若未找到，则说明不可达，向上层协议返回错误信息；
			- 若直接可达，则将路由表中的目的IP地址告知给网络接口程序；
			- 若不直接可达，则将路由表中对应的路由器IP地址通告给网络接口程序。
	2.接受。当IP接收到由网络接口程序传来的数据报时
		* 若接受节点为主机节点，则比较目报头中的目的地址与本机地址是否匹配，匹配则向上递交，否则丢弃。
		* 若接受节点为路由器节点，则需要转发该数据报，即用数据报的目的IP地址从路由表中查找转发路由，若找到就按该路由转发，否则向源主机发送ICMP报文，报告目的不可达。	
#### IP地址
	IP地址为32位二进制，由网络标识和主机标识组成。
	组成通常为：M(地址类别号)+网络号（netID）+主机号(hostId)
![](https://raw.githubusercontent.com/CICSilver/leetCode/master/1175356-20170611030523293-521600066.png)
上图为A类IP地址
![](https://raw.githubusercontent.com/CICSilver/leetCode/master/1175356-20170611030707325-1093708594.png)
上图为B类IP地址
![](https://raw.githubusercontent.com/CICSilver/leetCode/master/1175356-20170611031030231-921259957.png)
上图为C类IP地址
##### IP地址中的一些特殊规定
	* 全 0 时表示主机，只允许主机启动时使用
	* 全 1 表示在该网的广播地址，常用于初始化
	* 127.0.0.1表示回送地址，以此为目标地址的数据报将被IP立即送回，常用于测试网络。
	* 主机全为0，表示该IP为某网络的网络地址
	* 主机全为1，表示该网络的广播地址，若向该网络内的所有主机广播时，它是目标地址。
##### A,B,C,D,E类地址
	A类地址范围是：0.0.0.0 -- 127.255.255.255
	B类地址范围是：128.0.0.0 -- 191.255.255.255
	C类地址范围是： 192.0.0.0 -- 223.255.255.255
	D类地址范围是：224.0.0.0 -- 239.255.255.255
	E类地址范围是：240.0.0.0 -- 255.255.255.255
###### 各类地址区别
	* A类地址通常用于超大型网络
	* B类地址通常用于大型网络，适用于国际性大公司、政府等
	* C类地址校园网、企业网等
	* D类地址是多播地址
	Internet中允许有两类广播组：
		1.临时地址广播组，必须事先创建；
		2.永久地址广播组，不需要事先创建，常用于特殊目的
			* 224.0.0.1表示本网络所有主机和路由器
			* 224.0.0.2表示本网络所有的路由器
			* 224.0.0.5表示本网络所有的OSPF路由器
			* 224.0.0.6表示本网络指定的OSPF路由器
			* 224.0.0.9表示本网络所有的RIP路由器
	* E类地址是实验地址，保留用于研究，Internet上没有可用的E类地址
##### 私有地址(下列地址不可使用)
	A类：10.0.0.0 -- 10.255.255.255
	B类：172.16.0.0 -- 172.31.255.255
	C类：192.168.0.0 -- 192.168.255.255

### ARP和RARP
  RAP，地址解析协议，功能实是提供从IP地址到物理地址映像服务；
  RARP，逆向地址解析协议，功能是提供从物理地址到IP地址映像服务；
IP地址与物理地址之间的映射称为地址解析。
	目的：通过网络层将物理层隐藏起来，使TCP/IP与具体的物理网络无关。

#### ARP
ARP使在仅知道主机的IP地址的情况下确认其物理地址的一种协议
	ARP主要负责将32位的IP地址转换位48位的MAC地址(网卡上的MAC地址)
	
**转换过程**
	1.一台主机向目标主机发送包含IP地址信息的而广播报数据，即ARP请求
	2.目标主机向该主机发送一个含有IP地址和MAC地址的数据报
	3.通过MAC地址两个主机就能实现数据传输

假设有A，B两个主机，在TCP/IP中，A主机若要向B主机发送IP包，就需要在报头中填写B主机的IP地址，而这个IP包在以太网上传输时，还需要进行一次以太帧封装，在这个以太帧中，目标地址就是B主机的MAC地址。而A主机得知B主机MAC地址，靠的就是ARP协议。

具体步骤如下：
	1.A在不知道B的MAC地址的情况下，广播一个ARP请求，请求包中填上B的IP地址
	2.尽管以太网中的所有主机都会收到这一请求，但由于指定了IP地址，所以只有B主机会给出ARP应答包，其中就包含了B主机的MAC地址
	3.A得到ARP应答包后，将B的MAC地址放入本机缓存以便后用。本机MAC缓存是由生存期的，生存期结束后，A将回到初始状态（即未知B的MAC地址）并重复以上过程

注：局域网的网络流通不是根据IP地址进行的，而是根据MAC地址进行传输。一个IP包的流向是由路由表定义的，而IP包到达一个网段后，哪台机器来响应这个IP包，靠的是该IP包中包含的MAC地址。

##### ARP映射表
主机或交换机用于缓存同一网段设备IP地址和MAC地址的地方——ARP映射表，用于数据帧的转发。ARP表项分为动态ARP表项和静态ARP表项

##### 动态ARP表项
动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，可以被静态ARP表项覆盖。
当到达老化时间或接口关闭时，相应的动态ARP表项会被删除。
##### 静态ARP表项
静态ARP表项通过手工配置和维护。不会被老化，不会被动态ARP表项覆盖。
配置静态ARP表项可以增加通信的安全性，因为静态ARP可以限定和指定IP地址的设备通讯时只使用指定的MAC地址
此时ARP欺骗攻击无法修改此表项的IP地址和MAC地址的映射关系，从而达到保护本设备和制定设备的正常通信。
静态ARP表项又分为短静态ARO表项和长ARP静态表项。
 					
##### ARP欺骗
ARP欺骗分为两种：同网段ARP欺骗和不同网段ARP欺骗

###### 同网段的ARP欺骗，举个例子

	有三台主机A，B，C。他们的IP地址和MAC地址分别如下所示：
	A：IP地址 192.168.0.1	MAC地址 AA:AA:AA:AA:AA:AA
	B：IP地址 192.168.0.2	MAC地址 BB:BB:BB:BB:BB:BB
	C：IP地址 192.168.0.3	MAC地址 CC:CC:CC:CC:CC:CC

	如果一个位于主机B的用户想要非法入侵主机A，而主机A的防火墙只对主机C有信任关系(开放23端口(Telnet))，而他必须用Telnet进入主机A，此时应该如何处理？
	如果仅将主机B的IP地址改成主机C的IP地址，那么会与主机C形成一个竞争关系，如果此时你用其他手段使主机C宕机，那么也可以行得通，但这种方法不可靠，无法有效达成目标。
	但是，如果A和C的信任关系是建立在硬件地址基础上的，那么上面的方法就毫无用处了。这个时候就需要用ARP欺骗，让A主动把ARP缓存中关于192.168.0.3（C的IP地址）映射的硬件地址改为主机B的硬件地址。
	由于协议并没有规定必须发送请求包才能接受应答包，即可以伪造一个arp_reply响应包，就可以人为指定ARP包中的(源、目标)IP地址和(源、目标)MAC地址，从而可以达到修改A主机ARP缓存中映射表的目的。
###### 不同网段的ARP欺骗

	有三台主机A，B，C。他们的IP地址和MAC地址分别如下所示：
	A：IP地址 192.168.0.1	MAC地址 AA:AA:AA:AA:AA:AA
	B：IP地址 192.168.１.2	MAC地址 BB:BB:BB:BB:BB:BB
	C：IP地址 192.168.0.3	MAC地址 CC:CC:CC:CC:CC:CC
	
	这种情况与上一种情况最大的区别就是，即使欺骗成功，B和A也无法建立Telnet对话，因为路由器无法把A发送给B的包向外转发，路由器会发现地址在	192.168.0网段内
	
	该情况下，就需要另一种技术——ICMP重定向。将ARP欺骗和ICMP重定向相结合就可以达到目的。
	
ICMP重定向的定义
	ICMP重定向报文是ICMP控制报文的一种。该功能提供了一种路由优化控制机制，使源主机能以动态方式寻址最短路径。
	也就是说在特定情况下，当路由器检测到一台机器使用非优化路由的时候，它会向该主机发送一个ICMP重定向报文，请求主机改变路由。
	路由器也会把初始数据报向他的目的地转发。
	
下面是结合两种技术进行攻击的步骤：
	
	１.首先为了让自己的非法IP包存活的够久，要修改ip包的生存时间ttl，改长一点有利于做充足的广播
	
	2.寻找漏洞并利用漏洞当掉主机C
	
	3.在该网络的主机找不到原来的192.168.0.3后将更新自己的ARP映射表。
	此时人为发送一个ip地址位192.168.0.3，硬件地址为 BB:BB:BB:BB:BB:BB 的响应包。
	
	4.现在每台主机都知道192.168.0.3对应B主机的硬件地址了，一个ARP欺骗就完成了。
	但每个主机都只会在局域网中找这个地址而根本就不会把发送给192.168.0.3的IP包丢给路由器。所以接下来要继续构造一个ICMP重定向广播
	
	5.自己定制一个ICMP重定向包来告诉网络中的主机，
	“到192.168.0.3的路由最短路径不是局域网而是路由，请重定向路由路径，把所有发送给192.168.0.3的ip包丢给路由”
	
	6.主机A接收到这个合理的ICMP重定向，于是修改自己的路径，把相应的ip包都丢给路由
	
	7.入侵者可以在路由外收到来自路由内的主机ip包了，他可以开始telnet到主机的23口了。

注：23端口主要用于Telnet(远程登陆)服务

##### ARP报文格式

![ARP报文格式](https://raw.githubusercontent.com/CICSilver/leetCode/master/arp%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.png)

	·硬件类型：占两字节，表示ARP报文可以在哪种类型的网络上传输，值为1时表示为以太网地址。

	·上层协议类型：占两字节，表示硬件地址要映射的协议地址类型，映射IP地址时的值为0x0800。

	·MAC地址长度：占一字节，标识MAC地址长度，以字节为单位，此处为6。

	·IP协议地址长度：占一字节，标识IP得知长度，以字节为单位，此处为4。

	·操作类型：占2字节，指定本次ARP报文类型。1标识ARP请求报文，2标识ARP应答报文。

	·源MAC地址：占6字节，标识发送设备的硬件地址。

	·源IP地址：占4字节，标识发送方设备的IP地址。

	·目的MAC地址：占6字节，表示接收方设备的硬件地址，在请求报文中该字段值全为0，即00-00-00-00-00-00，表示任意地址，因为现在不知道这个MAC地址。

	·目的IP地址：占4字节，表示接受方的IP地址。

  由于ARP报文不是直接在网络层上发送的，它还需要向下传输到数据链路层，所以当ARP报文传输到数据链路层之后，需要再次进行封装。
  以以太网为例，ARP报文传输到以太网数据链路层后会形成ARP帧，格式如下图，就是在ARP报文前面加了一个以太网帧头

![ARP帧格式](https://raw.githubusercontent.com/CICSilver/leetCode/master/ARP%E5%B8%A7%E6%A0%BC%E5%BC%8F.png)

以太网帧头的三个字段说明

	·目的MAC地址：占6字节，如果是ARP请求帧，因为它是一个广播帧，所以要填上广播MAC地址（FF-FF-FF-FF-FF-FF），其目标主机是网络上的所有主机。

	·源MAC地址：占6字节，这是发送ARP帧的节点MAC地址。

	·帧类型：占两字节，这里用来标识帧封装的上层协议，因为本帧的数据部分是ARP报文，所以直接用ARP的协议号0x0806表示就可以了。

#### RARP

  如果一个主机初始化后只有自己的MAC地址而没有IP地址，就可以通过RARP协议发送广播式请求报文来获取自己的ip，RARP服务器负责对该请求做出应答。
  常用于无盘工作站来获取自己的IP地址
#### ICMP
  ICMP,因特网控制报文协议，是IP的一部分，必须包含在每一个IP中。
  ICMP数据报要通过IP发送出去，它有多种类型，可以提供多种服务。
  虽然ICMP由IP数据报传输，但并不把ICMP看作比IP更高层的协议。所以ICMP作为一个独立的协议，仅作为IP中的一个模块，来处理IP层中的控制问题。

　ICMP报文分为两种：
	1.ICMP差错报文
	2.ICMP控制报文

##### ICMP报文格式

![ICMP报文格式](https://raw.githubusercontent.com/CICSilver/leetCode/master/ICMP%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.jpg)



**ICMP类型值与报文类型**

|TYPE	 |ICMP报文类型 	|
| :-----:| :----------:	|
| 0	 | 回送响应	|
| 3	 | 目的不可达	|
| 4	 | 报源抑制	|
| 5	 | 重定向	|
| 8	 | 回送请求	|
| 11	 | 数据报超时	|
| 12	 | 数据报参数错	|
| 13	 | 时戳请求	|
| 14	 | 时戳响应	|
| 17	 | 屏蔽码请求	|
| 18	 | 屏蔽码响应	|

**代码域及意义**

|代码域	| 意义				|
| :----:| :---------------------------: |
| 0	| 网络不可达			|
| 1	| 主机不可达			|
| 2	| 协议不可达			|
| 3	| 端口不可达			|
| 4	| 需分段但标志禁止分段		|
| 5	| 源选址失败			|
| 6	| 目标网络未知			|
| 7	| 目标主机未知			|
| 8	| 源主机被隔离			|
| 9	| 禁止与目标网络通信		|
| 10	| 禁止与目标主机通信		|
| 11	| 对请求的服务类型，网络不可达	|
| 12 	| 对请求的服务类型，主机不可达	|

##### ICMP差错报文
  ICMP的基本功能就是提供差错报告传输机制。对于差错的处理方式，ICMP没有规定的处理方式。源主机在收到ICMP差错报文后，还需要与应用程序联系起来，才能决定相应的差错处理方式。
  ICMP的差错报告都是采用路由向源主机报告的模式，即当路由器发现IP数据报差错后，使用ICMP报文向该IP数据报的源主机报告其差错，同时丢弃出现差错的报文。
  
在ICMP差错报文中，共有三种报文，分别是：

	- 目的不可达报文   当路由表上查询不到该IP数据报的目标IP地址对应的路由器时，会发生目的不可达错误，此时路由器会回送一个该报文给源主机。
	目的不可达报文类型为3，并进一步细分成13种子类，用代码来标识，其他信息字段未用，为全0
	- 超时报文   如果在某个路由器上，数据报的生存时间减为了0，则该路由器会丢弃这个数据报，并向源主机发送Type=11,Code=0的ICMP报文。
	当目的主机在对数据报进行重装的过程中发生重装超时时，将丢弃已收到的各个分段数据报，并在第一个分段数据报到达后，回送Type=11,Code=1的报文
	- 参数出错报文   当路由器或目的主机在对收到的IP数据报进行处理时，若发现在IP报头参数中含有无法继续完成报文处理的错误，
	则将该数据报丢弃，并回送Type=12,Code=0的ICMP报文，并且在ICMP报文的其他信息字段中用1B作为指针来指出差错在数据报中的位置

##### ICMP控制报文
  ICMP控制报文主要用于**拥塞控制**和**路由控制**
  
	- 报源抑制报文   当数据报输入路由器的速度大于路由器的转发速度时，可能会发生拥塞现象。拥塞控制与流量控制最大的不同在于，流量控制是解决端到端的传输速率匹配问题，是局部控制；而拥塞控制带有全局性质，因为拥塞现象可能会影响到整个网络的数据传输，所以需要各个节点共同参与协同解决。
	- 重定向报文   该功能提供了一种路由优化控制机制，使源主机能以动态方式寻址最短路径。
	重定向报文类型为5，分为4个子类：
		* Code=0表示网络重定向数据报
		* Code=1表示主机重定向数据报
		* Code=2表示服务类型和网络重定向数据报
		* Code=3表示服务类型和主机重定向数据报
	在重定向报文的其他信息字段中要填入重定向的路由IP地址
	
##### ICMP请求/应答报文
+ 回送请求与响应报文
	- 回送请求与响应报文主要用于测试网络目的节点的可达性
+ 时戳请求与响应报文
	时戳请求与响应报文主要用于估算源节点和目的节点间的报文往返时间，报文中使用了3个时戳字段
	- 初始时戳  源节点发送时戳请求报文的时间
	- 接受时戳  目的节点接收到时戳请求报文的时间
	- 发送时戳  目的节点发送时戳响应报文的时间
+ 屏蔽码请求与响应报文
	- 主要用于源节点获取所在网络的IP地址屏蔽码信息。

### 传输层协议

#### 传输层端口
  传输层的功能之一就是提供了面向进程的通信机制。因此，传输层协议必须提供某种方法来标识进程。TCP/UDP通过端口(Port)来标识进程，端口相当于OSI传输层的服务访问点(TSAP)，它是一种抽象的软件结构，内部包含一些数据结构和I/O缓冲区。进程通过系统调用与某个或某些端口建立联系后，就可以使用相应的端口传输信息了。
  TCP和UDP的端口值都是16位，分别可以提供2^16个不同端口。
  TCP和UDP将端口分为两部分：
  
	1.保留端口，占全部端口的一小部分，以全局方式分配，又叫"周知"端口
	2.自由端口，占全部端口的绝大部分，以本地方式分配
  当一个进程与另一个进程通信之前，该进程首先申请一个本地自由端口，然后由已知的远地端口(“周知”端口或自由端口)与远地进程建立联系并进行数据传输
##### TCP常用端口分配表
| 端口号 | 协议名称    | 服务说明		|
| :----: | :---------: | :-------------------:	|  
| 20	 | FTP	       | 文件传输协议的数据连接	|
| 21	 | FTP	       | 文件传输协议的控制连接 |	
| 23	 | Telnet      | 终端连接		|
| 25     | SMTP	       | 简单邮件传输协议	|
| 53	 | DOMAIN      | 区域名字服务器		|
| 69	 | TFTP	       | 简单文件传输协议	|
| 80	 | HTTP	       | 超文本传输协议		|
| 110	 | POP3        | 邮局协议3.0版		|

##### UDP常用端口分配表
|端口号	| 关键字	| 服务说明		|	
|:----: | :-------:	| :-------------:	|
| 53	| DOMAIN	| 区域名字服务器	|
| 520	| RIP		| 路由协议		|
| 4000	| QQ		| QQ协议		|

#### TCP
  TCP提供面向连接的可靠字节流服务，即传输数据前必须先在两个不同的传输端口之间建立一条链路，一旦连接成功，两个进程间就会建立起一条虚电路，发送进程向他输入数据，接受进程从它依次取出数据。
  TCP的连接服务提供**全双工**方式，由两个方向相反的独立通道组成，可以同时向两个相反方向发送数据字节流。
  TCP由很大的独立性，它对下层网络协议只有基本的要求，很容易在不同的网络上应用。它对高层的数据结构无任何要求，只将它们作为一种连续的数据流，所以可以支持许多高层协议(ULP)。

##### TCP报文格式

![TCP报文格式](https://raw.githubusercontent.com/CICSilver/leetCode/master/TCP%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.gif)

|报头字段名|位数|说明|
| :--------:| :--:| :--------------------:|
| 源端口号|16|本地通信端口，支持TCP的多路复用机制|
|目的端口号|16|远地通信端口，支持TCP的多路复用机制|
|序号(seq)|32|数据段第一个数据字节的序号|
|确认号(ack)|32|SYN段的SYN序号(建立本次连接的初始序号)|
|报头长度|4|如果报头没有TCP选项字段，则报头长度值位5|
|控制字段：
|·URG|1|表示该段中带有紧急数据|
|·ACK|1|确认号字段有效的标志
|·PSH|1|PUSH操作的标志
|☆RST|1|要求中止通信连接的标志
|★SYN|1|请求建立连接的标志
|☆FIN|1|请求终止连接的标志
|窗口|16|表示本地接受窗口尺寸，即本地接收缓冲区大小
|校验和|16|包括TCP报头和数据在内的校验和
|紧急指针|16|从段序号开始的正向位移，指向紧急数据的最后1B
|选项|可变|提供任选的服务
|填充|可变|保证TCP报头以32位为边界对应

 ---
  TCP中的基本传输单元为段(Segment)，一个TCP段由段头和数据流两部分组成。由于TCP数据流是一个无结构字节流，无任何可供解释的结构，所以TCP段的长度是**可变**的。因此，TCP中的序号和确认号都是针对**字节流中的字节**而不是段的。

##### 紧急传输机制

在TCP提供的字节流传输服务中，总是先进入缓冲区的字节首先被传输，并抢先抵达接收端。而为了处理一些紧急传输，这就用到了URG位。

当URG位置1时，就表示此段TCP报文中有紧急数据，该数据的起始位置由紧急指针域表示。
接收端收到这种报文时将首先对它进行处理或递交给应用程序。因此，URG相当于一般传输协议中的加速数据传输或带外数据传输的功能。

为了保证传输的可靠性，接收方将确认已正确收到的连续字节流**前n字节**，给出的确认号指示的是**下一个(n+1)**所希望接收到的字节。

##### 建立连接-三次握手

![三次握手](https://raw.githubusercontent.com/CICSilver/leetCode/master/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png)

1. B首先处于LISTEN状态，等待客户的连接请求
2. A向B发送链接请求报文段，SYN=1，ACK=0，选择一个初始序号seq=x
3. B收到连接请求报文段，如果同意建立连接，则向A发送链接确认报文段,SYN=1，ACK=1，确认号ack=x+1，同时也选择一个初始的序号seq=y
4. A收到B的连接确认报文段后，还要向B发出确认，确认号ack=y+1，序号seq=x+1
5. B收到A的确认后，连接建立

* 第一次消息发送中，A随机选取一个序列号作为自己的初始序号发送给B；
* 第二次消息B使用ack对A的数据报进行确认，因为已经收到了序列号位x的数据报，准备接受序列号为x+1的包，所以ack=x+1，同时B告诉A自己的初始序列号,就是seq=q
* 第三条消息A告诉B收到了B的确认消息并准备建立连接，A自己此条消息的序列号时x+1,所以seq=x+1，而ack=y+1表示A正准备接受B序列号为y+1的数据报。

![第三次握手的用处](https://raw.githubusercontent.com/CICSilver/leetCode/master/%E7%AC%AC%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%9A%84%E7%94%A8%E5%A4%84.png)

##### 关闭连接-四次挥手
由于TCP连接是全双工的，因此每个方向要**单独**关闭。这一原则是当一方完成数据发送任务后，发送一个FIN来终止这一方向的连接

收到一个FIN只是表示**这一方向**上没有数据流动了，即不会再收到数据了，但是这个TCP连接上任然能够发送数据，知道这一方向也发送了FIN。

![四次挥手](https://raw.githubusercontent.com/CICSilver/leetCode/master/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png)

* 第一次挥手：客户端发送一个FIN，用来关闭客户端到服务器的数据传送，客户端进入   FIN_Wait_1状态
* 第二次挥手：服务器收到FIN后，发送一个ACK给客户端，确认序号为收到序号+ 1(与SYN相同，一个FIN占用一个序号)，服务器进入CLOSE_WAIT状态
* 第三次挥手：服务器发送一个FIN，用来关闭服务器到客户端的数据传送，服务器进入LAST_ACK状态
* 第四次挥手：客户端收到FIN后，客户端进入TIME_WAIT状态，接着发送一个ACK给服务器，确认序号为收到序号+1，服务器进入CLOSED状态，至此，完成四次挥手。

注：
1. 为什么建立连接是三次握手，而关闭连接确实四次挥手呢？

	因为建立连接时，服务器端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN在同一个报文中发送给客户端。
	而关闭连接时，一旦收到对方的FIN报文，仅表示对方不会再发送数据过来了，但仍然可以接受数据，己方也未必已经把数据全部发送给对方了。
	所以己方可以立即CLOSE，也可以发送一些数据给对方后再发送FIN给对方表示同意关闭连接。因此，己方ACK和FIN一般都会分开发送。

2. **为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能回到CLOSE状态？**
	* 不应该是为了防止B发送的FIN=1的包丢失，因为如果A没有收到来自B的释放连接请求，是不会进入TIME_WAIT状态的。
	* 正确的解释是：防止A发送的确认释放连接信息B没有收到，此时B会再次发送一个FIN=1的释放连接请求，而这个时候A还处于TIME_WAIT，所以可以再次发送确认信息。

##### 流量控制
  TCP采用一种称为信用证的动态窗口机制，主要通过TCP段中的"窗口"字段和"确认号"字段实现
"窗口"字段对应于TCP实体能够接受的数据的序号空间，**"确认号"表示TCP实体希望接受的下一个数据字节的序号**。

#### UDP
UDP提供的是一种面向无连接的传输服务，这种服务
* 不确认报文是否到达
* 不对报文排序
* 不进行流量控制

与TCP相同，UDP通过端口号支持多路复用机制，ULP可以通过端口地址共享单一的UDP实体

由于UDP功能少，所以它是一种简单的协议机制，通信开销小，效率比较高，适合多媒体通信等需求快捷、低延迟通信，且对可靠性要求不高的场合

#### DNS协议
域名系统，由于IP难以理解记忆而出现。
* 每一个IP网的主机或网关都有相应的域名。
* 一个主机域名唯一确定一个IP地址，一个IP地址对应若干域名

域名通常采用的层次结构是：

	···.次次高层.次高层.最高层

最右边的部分是顶级域名(TLD)，左边一个是二级域名(SLD)，再左边一个是三级域名，每一级域名控制它下一级域名的分配。
#### HTTP
超文本传输协议，Internet中最受欢迎的一种多媒体信息服务系统
