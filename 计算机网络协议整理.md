# 计算机网络协议整理

### OSI/RM模型---数据链路层协议---帧(frame)

#### 面向字符协议：利用已定义好的一种代码字符集的一个子集来执行通信控制功能---具体协议有 ISO 1745,BSC

##### 该协议面临的问题： 1.字符集不同
			2.数据字符和控制字符的区分
			3.控制字符占用了可传输信息的空间
			4.透明性差，需要复杂的转义技术（DLE）
	透明性：指链路控制与传输的代码结构完全无关

#### 面向位协议:以位置来定位各个字段，各字段内均由位的各种组合组成，并以帧为统一的传输单位---具体协议有 SDLC,ADCCP,HDLC,LAP,LAPB
		    	    |->ADCCP		    
	关系为   SDLC(最初) | ->HDLC ->LAP ->LAPB
	（这些协议基本内容相同）

### OSI/RM模型---网络层---数据包/分组(packet)

#### X.25协议：定义了用户主机（数据终端设备，DTE）和报文分组网通信设备(数据终接设备，DCE)。
	具体地说，它是3个对等协议的组合：
	- DTE和DCE物理实体之间对等层协议
	- DTE和DCE数据链路层之间的对等层协议
	- DTE和DCE网络层之间的对等层协议
它定义了这三个层在DTE和DCE之间交换信息的格式和意义。（即包含了三个协议层）
### OSI/RM模型---传输层---段(segment)

#### 该层协议共分为5类

	协议类	网络类型	  名称
	  0       A类		简单类
	  1 	  B类		基本错误恢复类
	  2 	  A类   	多路复用类
	  3	  B类		差错恢复与多路复用类
	  4	  C类   	差错检测和恢复类

其中，网络类型的区别为：A型---具由可接受的残留差错率和失效通知率
			B型---具由可接受的残留差错率
			C型---两者都不可接受

##### TCP，传输控制协议
	TCP是TCP/IP中传输层采用的一种协议
	它从上层实体接受任意长度的报文，并为上层用户提供面向连接的，可靠的全双工数据传输服务。
	它是一种面向连接的协议，需要在一对高层实体间提供建立连接和释放连接的功能，连接方法是利用套接字。
	它适用于可靠或不可靠的网络。
##### UDP，用户数据报协议
	UDP是一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。
	它不提供数据包分组、组装，不能对数据包进行排序。
	常用于支持那些需要在计算机之间传输数据的网络应用。
### OSI/RM模型---会话层---数据(data)
	

### 高层协议
	以下列举的应用、表示、会话层协议可供用（由于实际的网络协议将它们归了一类所致）
#### 具有会话层功能
	ADSP·ASP·H.245·ISO-SP·iSNS·NetBIOS·PAP·RPC·
	
	RTCP·SMPP·SCP·SSH·ZIP·SDP
#### 会话层功能
	

	会话层内的供能就是会话实体为了提供会话服务应执行的那些功能，这些功能必须由会话实体来完成。
	1.会话连接到传输连接的映射
	2.会话连接的流程控制
	3.加速数据传送
	4.会话连接的恢复
	5.会话连接释放
	6.会话连接管理
### OSI/RM模型---表示层---数据(data)
#### 具有表示层功能		
	HTTP/HTML · Telnet · ASN.1
### 表示层功能
	1.表示实体之间的连接建立、释放
	2.数据语法和图像语法的表示和转换
	3.传送语法的选择
	4.数据变换的特殊处理，如代码压缩 、密码转换等
### OSI/RM模型---应用层---数据(data)
#### 应用层协议
##### 文件传输协议---FTP
	它基于传输层为用户服务，负责进行文件的传输。它能操作任何类型的文件而不需要进一步的处理，但是有着极高的延迟	
##### 电子邮件协议---SMTP、POP3、IMAP4
###### SMTP协议，简单邮件传输协议。
	它是一组用于从源地址到目的地址传输邮件的规范，通过它来控制邮件的中转方式。
###### POP3协议，邮局协议的第三个版本
	它是因特网电子邮件的第一个离线协议标准。
###### IMAP4
	POP3的一种替代协议，添加了邮件检索与处理等新功能
##### 远程登录协议--- Telnet
	它是Internet远程登录服务的标准协议和主要方式。
	通过创建虚拟终端提供连接到远程终端的仿真，通过用户名和密码进行认证，为用户提供了在本地计算机上完成远程主机工作的能力。
##### 简单网络管理协议 --- SNMP、SNMP V2
	其被采纳为基于TCP\IP的各种互联网络的管理标准。
	它的核心思想就是，在每个网络节点上存放一个管理信息库（MIB），由节点上的代理负责维护，管理者通过应用层协议对这些信息库进行管理。
	它的最大特点就是 简单性 
	SNMP标准   由3部分组成：
	1.简单网络管理协议---SNMP
	2.管理信息结构---SMI
	3.管理信息库---MIB

注：SMI和MIB 是两个关于管理信息标准的协议，它们规定了被管理的网络对象的定义格式，MIB中包含哪些对象，以及怎样访问这些对象等。SMI规定了定义个标识变量的一组原则，它规定所有的MIB对象必须用ASN.1来定义。

## 局域网（LAN）中的协议
### 总线竞争型媒体访问控制方法
	总线型网常采用的是CSMA/CD协议，即带有冲突检测的载体侦听多路访问协议。它是一种采用随机访问技术的竞争型媒体访问控制方法，起源于ALOHA协议。
#### ALOHA协议
##### 纯ALOHA协议
	- 当传输点有数据需要传送的时候，它会立即向通讯频道传送。
	- 接收点在收到数据后，发送ACK帧（返回应答消息）回传输点。
	- 如果接收的数据有错误，接收点会向传输点发送NACK。
	- 当网络上的两个传输点同时向频道传输数据的时候，会发生冲突，这	种情况下，两个点各自等待一段随机长度的时间后，再次尝试传送。
	这种协议下，信道吞吐率很低
##### 分段ALOHA
	这是对纯ALOHA协议的一个改进。改进之处在于，它把频道在时间上分段，每个传输点只能在一个分段的开始处进行传送。每次传送的数据必须少于或者等于一个频道的一个时间分段。这样大大的减少了传输频道的冲突。
	
##### 载体侦听多路访问/冲突检测,即CSMA/CD协议
###### CSMA/CD的物理含义
	各站点在发送消息前，先侦听总线上是否有信息在传送。
若有，则不发，以免破坏传送；若没有，则发送。

	多路访问，是指当一个站点发送信息时，其他站点使用各自的接收器收听（类似于广播）。
	若目标地址是广播地址，则总线上所有站点都将接受信息并放在各自的缓冲区内以便处理；
	若目标地址是某指定站点，则该指定站点将接受信息；
	若目标地址是一个组地址，则该组地址都将接受信息；

	冲突检测，指当一个站点占用总线发送信息时，要一边发送一边检测总线，看是否有冲突产生。

	冲突的产生有两个原因：
	1.两个站点同时侦听到线路空闲，又同时发送信息导致冲突
	2.A站点刚发送信息还没有到达B站，B站此时检测到线路空闲，发送数据到总线上，导致冲突
###### CSMA/CD的特点
	该协议采用竞争的方法强占对媒体的访问权利。
	最小帧长为512位（64B）
	优点：
	1.结构简单
	2.网络维护方便
	3.增删节点容易
	4.网络在轻负载情况下效率较高
	缺点：
	1.重负载情况下，冲突概率增加，性能明显下降
	2.为了满足最小帧长的要求，额外添加的填充字段浪费了信道容量

## TCP/IP 网络通信协议
### TCP/IP的结构
	TCP/IP包括四层协议：
	1.应用层，应用程序间沟通的层
	2.传输层，提供节点间的数据传送，应用程序之间的通信服务，主要功能是数据格式化，数据确认和丢失重传
	3.网络层，负责提供基本的数据封包传送功能
	4.网络接口层（主机-网络层），接受IP数据报并进行传输，抽取IP数据报转交给下一层，是对实际的网络媒体的管理，定义如何使用实际网络来传送数据
### TCP/IP是一组协议的代名词，它还包括其他一些协议。

	TCP --- 传输层协议，负责流量控制和校验正确性
	IP  --- 网络层协议，负责传输数据

	在TCP/IP协议中，除了TCP和IP外，还有：
	- ARP，地址解析协议,此协议将网络地址映射到硬件地址，属于网络层协议
	- RARP，反向地址解析协议，此协议将硬件地址映射到网络地址，属于网络层协议
	- ICMP，网间报文控制协议，属于网络层协议
	- UDP，用户数据报协议，提供无连接服务，属于传输层协议
	- FTP，文件传输协议，允许用户以文件操作的方式与另一台主机相互通信，属于应用层协议
	- SMTP，简单邮件传输协议，属于应用层协议
	- Telnet，远程登陆协议，属于应用层协议
	- TFTP，简单文件传输协议，属于应用层协议
### 网络层协议
	网络层协议的主要功能是实现互联网络环境下的数据分组传输
	这些功能主要由4个功能实现：
	IP，ARP，RARP，ICMP
	
	IP --- 提供数据分组传输、路由选择等功能；
	ARP、RARP --- 提供逻辑地址与物理地址映射的功能
	ICMP --- 提供网络控制和差错处理功能
#### IPv4,即IP
	IP，提供无连接的数据报传输机制，IP数据报的格式与一般帧类似，分为报头和数据区两个部分
##### IP数据报格式
	格式如下图：
	！[图片]（图片地址）

	- 版本：IP协议的版本，目前的IP协议版本号为4，下一代IP协议版本号为6。


	- 首部长度：IP报头的长度。固定部分的长度（20字节）和可变部分的长度之和。共占4位。最大为1111，即10进制的15，代表IP报头的最大长度可以为15个32bits（4字节），也就是最长可为15*4=60字节，除去固定部分的长度20字节，可变部分的长度最大为40字节。
	
- 
服务类型：Type Of Service。


	- 总长度：IP报文的总长度。报头的长度和数据部分的长度之和。
	

- 标识：唯一的标识主机发送的每一分数据报。通常每发送一个报文，它的值加一。当IP报文长度超过传输网络的MTU（最大传输单元）时必须分片，这个标识字段的值被复制到所有数据分片的标识字段中，使得这些分片在达到最终目的地时可以依照标识字段的内容重新组成原先的数据。


	- 标志：共3位。R、DF、MF三位。目前只有后两位有效，DF位：为1表示不分片，为0表示分片。MF：为1表示“更多的片”，为0表示这是最后一片。


	- 片位移：本分片在原先数据报文中相对首位的偏移位。（需要再乘以8）
	- 

生存时间：IP报文所允许通过的路由器的最大数量。每经过一个路由器，TTL减1，当为0时，路由器将该数据报丢弃。TTL 字段是由发送端初始设置一个 8 bit字段.推荐的初始值由分配数字 RFC 指定，当前值为 64。发送 ICMP 回显应答时经常把 TTL 设为最大值 255。
	- 

协议：指出IP报文携带的数据使用的是那种协议，以便目的主机的IP层能知道要将数据报上交到哪个进程（不同的协议有专门不同的进程处理）。和端口号类似，此处采用协议号，TCP的协议号为6，UDP的协议号为17。ICMP的协议号为1，IGMP的协议号为2.


	- 首部校验和：计算IP头部的校验和，检查IP报头的完整性。
	

- 源IP地址：标识IP数据报的源端设备。
	- 

目的IP地址：标识IP数据报的目的地址。
	- 可选字段：用以指定额外服务
##### 数据报的分段与重装
	1.分段，为了适应不同物理网络的信息传输，IP将对上层协议提交的协议根据物理网络允许的最大帧长进行检查，必要时会分段发送。
	分段时每一段都要加上IP报头，形成IP数据报（与分段有关的报头字段有，标识，报文长度，分段偏移，标志）
	2.重装，被分段的数据报在到达目标主机前可能经过不同路由器，导致到达顺序与发送时不同，因此IP必须根据报头中的相关字段重组数据报再提交给上层协议
##### 数据报的发送和接受
	1.发送。
		* 若上层协议已指定发送路由，则按指定路由发送数据报；
		+ 若上层协议未指定发送路由，则以报头中指定的IP地址为关键字来搜索路由表中的路由。若未找到，则说明不可达，向上层协议返回错误信息；
			- 若直接可达，则将路由表中的目的IP地址告知给网络接口程序；
			- 若不直接可达，则将路由表中对应的路由器IP地址通告给网络接口程序。
	2.接受。当IP接收到由网络接口程序传来的数据报时
		* 若接受节点为主机节点，则比较目报头中的目的地址与本机地址是否匹配，匹配则向上递交，否则丢弃。
		* 若接受节点为路由器节点，则需要转发该数据报，即用数据报的目的IP地址从路由表中查找转发路由，若找到就按该路由转发，否则向源主机发送ICMP报文，报告目的不可达。	
#### IP地址
	IP地址为32位二进制，由网络标识和主机标识组成。
	组成通常为：M(地址类别号)+网络号（netID）+主机号(hostId)
	[图片](图片链接)
	上图为A类IP地址
	[图片](图片链接)
	上图为B类IP地址
	[图片](图片连接)
	上图为C类IP地址
##### IP地址中的一些特殊规定
	* 全 0 时表示主机，只允许主机启动时使用
	* 全 1 表示在该网的广播地址，常用于初始化
	* 127.0.0.1表示回送地址，以此为目标地址的数据报将被IP立即送回，常用于测试网络。
	* 主机全为0，表示该IP为某网络的网络地址
	* 主机全为1，表示该网络的广播地址，若向该网络内的所有主机广播时，它是目标地址。
##### A,B,C,D,E类地址
	A类地址范围是：0.0.0.0 -- 127.255.255.255
	B类地址范围是：128.0.0.0 -- 191.255.255.255
	C类地址范围是： 192.0.0.0 -- 223.255.255.255
	D类地址范围是：224.0.0.0 -- 239.255.255.255
	E类地址范围是：240.0.0.0 -- 255.255.255.255
###### 各类地址区别
	* A类地址通常用于超大型网络
	* B类地址通常用于大型网络，适用于国际性大公司、政府等
	* C类地址校园网、企业网等
	* D类地址是多播地址
	Internet中允许有两类广播组：
		1.临时地址广播组，必须事先创建；
		2.永久地址广播组，不需要事先创建，常用于特殊目的
			* 224.0.0.1表示本网络所有主机和路由器
			* 224.0.0.2表示本网络所有的路由器
			* 224.0.0.5表示本网络所有的OSPF路由器
			* 224.0.0.6表示本网络指定的OSPF路由器
			* 224.0.0.9表示本网络所有的RIP路由器
	* E类地址是实验地址，保留用于研究，Internet上没有可用的E类地址
##### 私有地址(下列地址不可使用)
	A类：10.0.0.0 -- 10.255.255.255
	B类：172.16.0.0 -- 172.31.255.255
	C类：192.168.0.0 -- 192.168.255.255

### ARP和RARP
  RAP，地址解析协议，功能实是提供从IP地址到物理地址映像服务；
  RARP，逆向地址解析协议，功能是提供从物理地址到IP地址映像服务；
IP地址与物理地址之间的映射称为地址解析。
	目的：通过网络层将物理层隐藏起来，使TCP/IP与具体的物理网络无关。

#### ARP
ARP使在仅知道主机的IP地址的情况下确认其物理地址的一种协议
	ARP主要负责将32位的IP地址转换位48位的MAC地址(网卡上的MAC地址)
	
**转换过程**
	1.一台主机向目标主机发送包含IP地址信息的而广播报数据，即ARP请求
	2.目标主机向该主机发送一个含有IP地址和MAC地址的数据报
	3.通过MAC地址两个主机就能实现数据传输

假设有A，B两个主机，在TCP/IP中，A主机若要向B主机发送IP包，就需要在报头中填写B主机的IP地址，而这个IP包在以太网上传输时，还需要进行一次以太帧封装，在这个以太帧中，目标地址就是B主机的MAC地址。而A主机得知B主机MAC地址，靠的就是ARP协议。

具体步骤如下：
	1.A在不知道B的MAC地址的情况下，广播一个ARP请求，请求包中填上B的IP地址
	2.尽管以太网中的所有主机都会收到这一请求，但由于指定了IP地址，所以只有B主机会给出ARP应答包，其中就包含了B主机的MAC地址
	3.A得到ARP应答包后，将B的MAC地址放入本机缓存以便后用。本机MAC缓存是由生存期的，生存期结束后，A将回到初始状态（即未知B的MAC地址）并重复以上过程

注：局域网的网络流通不是根据IP地址进行的，而是根据MAC地址进行传输。一个IP包的流向是由路由表定义的，而IP包到达一个网段后，哪台机器来响应这个IP包，靠的是该IP包中包含的MAC地址。

##### ARP映射表
主机或交换机用于缓存同一网段设备IP地址和MAC地址的地方——ARP映射表，用于数据帧的转发。ARP表项分为动态ARP表项和静态ARP表项

##### 动态ARP表项
动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，可以被静态ARP表项覆盖。
当到达老化时间或接口关闭时，相应的动态ARP表项会被删除。
##### 静态ARP表项
静态ARP表项通过手工配置和维护。不会被老化，不会被动态ARP表项覆盖。
配置静态ARP表项可以增加通信的安全性，因为静态ARP可以限定和指定IP地址的设备通讯时只使用指定的MAC地址
此时ARP欺骗攻击无法修改此表项的IP地址和MAC地址的映射关系，从而达到保护本设备和制定设备的正常通信。
静态ARP表项又分为短静态ARO表项和长ARP静态表项。
 					
##### ARP欺骗
ARP欺骗分为两种：同网段ARP欺骗和不同网段ARP欺骗

###### 同网段的ARP欺骗，举个例子

	有三台主机A，B，C。他们的IP地址和MAC地址分别如下所示：
	A：IP地址 192.168.0.1	MAC地址 AA:AA:AA:AA:AA:AA
	B：IP地址 192.168.0.2	MAC地址 BB:BB:BB:BB:BB:BB
	C：IP地址 192.168.0.3	MAC地址 CC:CC:CC:CC:CC:CC

	如果一个位于主机B的用户想要非法入侵主机A，而主机A的防火墙只对主机C有信任关系(开放23端口(Telnet))，而他必须用Telnet进入主机A，此时应该如何处理？
	如果仅将主机B的IP地址改成主机C的IP地址，那么会与主机C形成一个竞争关系，如果此时你用其他手段使主机C宕机，那么也可以行得通，但这种方法不可靠，无法有效达成目标。
	但是，如果A和C的信任关系是建立在硬件地址基础上的，那么上面的方法就毫无用处了。这个时候就需要用ARP欺骗，让A主动把ARP缓存中关于192.168.0.3（C的IP地址）映射的硬件地址改为主机B的硬件地址。
	由于协议并没有规定必须发送请求包才能接受应答包，即可以伪造一个arp_reply响应包，就可以人为指定ARP包中的(源、目标)IP地址和(源、目标)MAC地址，从而可以达到修改A主机ARP缓存中映射表的目的。
###### 不同网段的ARP欺骗

	有三台主机A，B，C。他们的IP地址和MAC地址分别如下所示：
	A：IP地址 192.168.0.1	MAC地址 AA:AA:AA:AA:AA:AA
	B：IP地址 192.168.１.2	MAC地址 BB:BB:BB:BB:BB:BB
	C：IP地址 192.168.0.3	MAC地址 CC:CC:CC:CC:CC:CC
	
	这种情况与上一种情况最大的区别就是，即使欺骗成功，B和A也无法建立Telnet对话，因为路由器无法把A发送给B的包向外转发，路由器会发现地址在	192.168.0网段内
	
	该情况下，就需要另一种技术——ICMP重定向。将ARP欺骗和ICMP重定向相结合就可以达到目的。
	
ICMP重定向的定义
	ICMP重定向报文是ICMP控制报文的一种。该功能提供了一种路由优化控制机制，使源主机能以动态方式寻址最短路径。
	也就是说在特定情况下，当路由器检测到一台机器使用非优化路由的时候，它会向该主机发送一个ICMP重定向报文，请求主机改变路由。
	路由器也会把初始数据报向他的目的地转发。
	
下面是结合两种技术进行攻击的步骤：
	
	１.首先为了让自己的非法IP包存活的够久，要修改ip包的生存时间ttl，改长一点有利于做充足的广播
	
	2.寻找漏洞并利用漏洞当掉主机C
	
	3.在该网络的主机找不到原来的192.168.0.3后将更新自己的ARP映射表。
	此时人为发送一个ip地址位192.168.0.3，硬件地址为 BB:BB:BB:BB:BB:BB 的响应包。
	
	4.现在每台主机都知道192.168.0.3对应B主机的硬件地址了，一个ARP欺骗就完成了。
	但每个主机都只会在局域网中找这个地址而根本就不会把发送给192.168.0.3的IP包丢给路由器。所以接下来要继续构造一个ICMP重定向广播
	
	5.自己定制一个ICMP重定向包来告诉网络中的主机，
	“到192.168.0.3的路由最短路径不是局域网而是路由，请重定向路由路径，把所有发送给192.168.0.3的ip包丢给路由”
	
	6.主机A接收到这个合理的ICMP重定向，于是修改自己的路径，把相应的ip包都丢给路由
	
	7.入侵者可以在路由外收到来自路由内的主机ip包了，他可以开始telnet到主机的23口了。

注：23端口主要用于Telnet(远程登陆)服务

##### ARP报文格式

![ARP报文格式](https://raw.githubusercontent.com/CICSilver/leetCode/master/arp%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.png)

	·硬件类型：占两字节，表示ARP报文可以在哪种类型的网络上传输，值为1时表示为以太网地址。

	·上层协议类型：占两字节，表示硬件地址要映射的协议地址类型，映射IP地址时的值为0x0800。

	·MAC地址长度：占一字节，标识MAC地址长度，以字节为单位，此处为6。

	·IP协议地址长度：占一字节，标识IP得知长度，以字节为单位，此处为4。

	·操作类型：占2字节，指定本次ARP报文类型。1标识ARP请求报文，2标识ARP应答报文。

	·源MAC地址：占6字节，标识发送设备的硬件地址。

	·源IP地址：占4字节，标识发送方设备的IP地址。

	·目的MAC地址：占6字节，表示接收方设备的硬件地址，在请求报文中该字段值全为0，即00-00-00-00-00-00，表示任意地址，因为现在不知道这个MAC地址。

	·目的IP地址：占4字节，表示接受方的IP地址。

  由于ARP报文不是直接在网络层上发送的，它还需要向下传输到数据链路层，所以当ARP报文传输到数据链路层之后，需要再次进行封装。
  以以太网为例，ARP报文传输到以太网数据链路层后会形成ARP帧，格式如下图，就是在ARP报文前面加了一个以太网帧头

![ARP帧格式](https://raw.githubusercontent.com/CICSilver/leetCode/master/ARP%E5%B8%A7%E6%A0%BC%E5%BC%8F.png)

以太网帧头的三个字段说明

	·目的MAC地址：占6字节，如果是ARP请求帧，因为它是一个广播帧，所以要填上广播MAC地址（FF-FF-FF-FF-FF-FF），其目标主机是网络上的所有主机。

	·源MAC地址：占6字节，这是发送ARP帧的节点MAC地址。

	·帧类型：占两字节，这里用来标识帧封装的上层协议，因为本帧的数据部分是ARP报文，所以直接用ARP的协议号0x0806表示就可以了。

#### RARP

  如果一个主机初始化后只有自己的MAC地址而没有IP地址，就可以通过RARP协议发送广播式请求报文来获取自己的ip，RARP服务器负责对该请求做出应答。
	
	
